<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pocket</title>
    
    <link rel="apple-touch-icon" href="icon.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;600&family=Lora:ital,wght@0,400;0,600;1,400&family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --font-cormorant: 'Cormorant Garamond', serif;
            --font-playfair: 'Playfair Display', serif;
            --font-lora: 'Lora', serif;
            --font-inter: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --transition: 0.3s ease;
        }

        /* --- BASE COLORS --- */
        body.theme-dusk {
            --bg-main: #121214;
            --bg-card: #1c1c1f;
            --bg-input: #27272a;
            --text-main: #e4e4e7;
            --text-muted: #a1a1aa;
            --border: rgba(255,255,255,0.1);
            --shadow-color: rgba(0,0,0,0.4);
            --bg-button: rgba(255,255,255,0.08);
            --header-bg: #121214;
        }

        body.theme-dawn {
            --bg-main: #f0ebe6;
            --bg-card: #fdfbf7;
            --bg-input: #e6e0d8;
            --text-main: #292524;
            --text-muted: #78716c;
            --border: rgba(0,0,0,0.08);
            --shadow-color: rgba(0,0,0,0.05);
            --bg-button: rgba(0,0,0,0.05);
            --header-bg: #f0ebe6;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            margin: 0;
            font-family: var(--current-font, var(--font-cormorant));
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            transition: background-color var(--transition), color var(--transition);
        }

        /* --- THEME SPECIFIC COLORS (Auto-switching for Light Mode) --- */
        
        /* Default Colors (Dark Mode) */
        .t-gold     { --accent: #8a7e66; --accent-border: #8a7e66; }
        .t-sapphire { --accent: #5e7b87; --accent-border: #5e7b87; }
        .t-sage     { --accent: #738062; --accent-border: #738062; }
        .t-rose     { --accent: #9c6b6b; --accent-border: #9c6b6b; }
        
        /* Light Mode Overrides (Darker, richer versions for contrast against white) */
        body.theme-dawn .t-gold     { --accent: #5c523e; --accent-border: #c9c2b3; }
        body.theme-dawn .t-sapphire { --accent: #364952; --accent-border: #b1c1c7; }
        body.theme-dawn .t-sage     { --accent: #454d3a; --accent-border: #bdc4b3; }
        body.theme-dawn .t-rose     { --accent: #634040; --accent-border: #d4baba; }

        /* --- PATTERN THEMES (Sophisticated Update) --- */

        /* 1. MORRIS (Foresty/Patterned) */
        .t-morris { 
            background-color: #2F3E34 !important; 
            color: #E8E6DF !important; 
            --accent: #E8E6DF; /* Text color inside card */
            --accent-border: #5C6F63;
        }
        .t-morris::before {
            content: ''; position: absolute; top: 6px; left: 6px; right: 6px; bottom: 6px;
            border: 3px double #8a7e66; opacity: 0.3; pointer-events: none; z-index: 0;
        }

        /* 2. VELVET (Deep Red) */
        .t-velvet {
            background-color: #3b1e20 !important;
            background-image: radial-gradient(circle, #4a2528 10%, transparent 10%), radial-gradient(circle, #4a2528 10%, transparent 10%);
            background-size: 20px 20px;
            color: #ebd5d5 !important;
            --accent: #ebd5d5;
            --accent-border: #5e3a3d;
        }
        .t-velvet::before {
            content: ''; position: absolute; top: 6px; left: 6px; right: 6px; bottom: 6px;
            border: 3px double #5e3a3d; opacity: 0.3; pointer-events: none; z-index: 0;
        }
        body.theme-dawn .t-velvet {
            background-color: #f4ecec !important;
            color: #4a2225 !important;
            --accent: #4a2225;
            --accent-border: #dccbcb;
        }

        /* 3. PONTING (Crystalline Blue) */
        .t-ponting {
            background-color: #162032 !important; 
            background-image: 
                radial-gradient(circle at 90% 10%, rgba(56, 189, 248, 0.15) 0%, transparent 60%),
                radial-gradient(circle at 10% 90%, rgba(129, 140, 248, 0.15) 0%, transparent 60%) !important;
            color: #e0f2fe !important; 
            --accent: #e0f2fe;
            --accent-border: #1e3a8a; /* Darker border */
        }
        .t-ponting::before {
            content: ''; position: absolute; top: 6px; left: 6px; right: 6px; bottom: 6px;
            border: 1px solid #7dd3fc; opacity: 0.15; pointer-events: none; z-index: 0;
        }
        body.theme-dawn .t-ponting {
            background-color: #f0f9ff !important;
            color: #0c4a6e !important;
            --accent: #0c4a6e;
        }

        /* 4. inferno (Deep Wine - Toned Down) */
        .t-inferno {
            background-color: #1a0505 !important; /* Very dark brownish red */
            background-image: 
                radial-gradient(circle at 90% 10%, rgba(159, 18, 57, 0.15) 0%, transparent 60%),
                radial-gradient(circle at 10% 90%, rgba(136, 19, 55, 0.15) 0%, transparent 60%) !important;
            color: #ffe4e6 !important; 
            --accent: #ffe4e6;
            --accent-border: #4c0519; /* Subtle deep red border */
        }
        .t-inferno::before {
            content: ''; position: absolute; top: 6px; left: 6px; right: 6px; bottom: 6px;
            border: 1px solid #fda4af; opacity: 0.1; pointer-events: none; z-index: 0;
        }
        body.theme-dawn .t-inferno {
            background-color: #fff1f2 !important;
            color: #881337 !important;
            --accent: #881337;
        }

        /* 5. forest (Deep Forest - Toned Down) */
        .t-forest {
            background-color: #022c22 !important; /* Deepest green */
            background-image: 
                radial-gradient(circle at 90% 10%, rgba(6, 78, 59, 0.3) 0%, transparent 60%),
                radial-gradient(circle at 10% 90%, rgba(2, 44, 34, 0.3) 0%, transparent 60%) !important;
            color: #d1fae5 !important; 
            --accent: #d1fae5;
            --accent-border: #064e3b; /* Subtle deep green border */
        }
        .t-forest::before {
            content: ''; position: absolute; top: 6px; left: 6px; right: 6px; bottom: 6px;
            border: 1px solid #6ee7b7; opacity: 0.1; pointer-events: none; z-index: 0;
        }
        body.theme-dawn .t-forest {
            background-color: #f0fdf4 !important;
            color: #064e3b !important;
            --accent: #064e3b;
        }

        /* --- CARD STYLES --- */
        .card-frame {
            position: relative;
            background: var(--bg-card);
            border: 1px solid var(--border);
            box-shadow: 0 4px 20px var(--shadow-color);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        /* Generic border for non-pattern themes */
        .card-frame:not(.t-morris):not(.t-velvet):not(.t-ponting):not(.t-inferno):not(.t-forest)::before {
            content: ''; position: absolute; top: 6px; left: 6px; right: 6px; bottom: 6px;
            border: 1px solid var(--accent-border); opacity: 0.3; pointer-events: none; z-index: 0;
        }
        
        /* Titles use the css variable now */
        .theme-title { color: var(--accent); }

        /* Utilities */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .sticky-header {
            position: sticky; top: 0; z-index: 50;
            background-color: var(--header-bg);
            padding-top: max(20px, env(safe-area-inset-top)); 
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            transition: background-color 0.3s ease;
        }
        
        .tag-pill {
            font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em;
            padding: 4px 10px; border-radius: 99px; background: var(--bg-button);
            color: var(--text-muted); border: 1px solid var(--border); white-space: nowrap;
        }
        .tag-pill.active {
            background: var(--text-main); color: var(--bg-main); border-color: var(--text-main);
        }

        .poem-content strong { font-weight: 700; color: inherit; }
        .poem-content em { font-style: italic; opacity: 0.8; }
    </style>
</head>
<body class="theme-dusk">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS ---
        const Icon = ({ name, size = 20, className }) => {
            const icons = {
                ArrowLeft: <path d="m12 19-7-7 7-7 M19 12H5"/>,
                Plus: <path d="M5 12h14 M12 5v14"/>,
                Trash: <path d="M3 6h18 M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6 M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>,
                Sun: <g><circle cx="12" cy="12" r="4"/><path d="M12 2v2 M12 20v2 M4.93 4.93l1.41 1.41 M17.66 17.66l1.41 1.41 M2 12h2 M20 12h2 M6.34 17.66l-1.41 1.41 M19.07 4.93l-1.41 1.41"/></g>,
                Moon: <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>,
                Settings: <g><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></g>,
                Copy: <g><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></g>,
                Search: <g><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></g>,
                Sort: <path d="M3 6h18M7 12h10M10 18h4"/>,
                Edit: <g><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></g>,
                Upload: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></g>,
                Music: <g><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></g>,
                Headphones: <g><path d="M3 18v-6a9 9 0 0 1 18 0v6"/><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/></g>,
                User: <g><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></g>,
                List: <g><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></g>
                Spotify: <g><circle cx="12" cy="12" r="10"/><path d="M8 11.5c2.5-1 5.5-1 8 0 M7 14.5c3-1 6-1 9 0 M6 8.5c4-1.5 8-1.5 12 0"/></g>,
                YouTube: <g><rect x="2" y="4" width="20" height="16" rx="4"/><polygon points="10,8 16,12 10,16" fill="currentColor"/></g>,
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                </svg>
            );
        };

        // --- CONFIG ---
        const THEMES = [
            { id: 'gold', color: '#8a7e66', name: 'Gold' },
            { id: 'sapphire', color: '#5e7b87', name: 'Sapphire' },
            { id: 'sage', color: '#738062', name: 'Sage' },
            { id: 'rose', color: '#9c6b6b', name: 'Rose' },
            { id: 'morris', color: '#4a5d4a', name: 'Morris' },
            { id: 'velvet', color: '#753a3a', name: 'Velvet' },
            { id: 'ponting', color: '#38bdf8', name: 'Ponting' },
            { id: 'inferno', color: '#9f1239', name: 'Inferno' }, // Darker Red for UI icon
            { id: 'forest', color: '#064e3b', name: 'Forest' } // Darker Green for UI icon
        ];

        const FONTS = [
            { id: 'cormorant', name: 'Cormorant', css: "'Cormorant Garamond', serif" },
            { id: 'playfair', name: 'Playfair', css: "'Playfair Display', serif" },
            { id: 'lora', name: 'Lora', css: "'Lora', serif" },
            { id: 'inter', name: 'Modern Sans', css: "'Inter', sans-serif" },
            { id: 'mono', name: 'Typewriter', css: "'JetBrains Mono', monospace" }
        ];

        const SORT_OPTIONS = [
            { id: 'added_desc', label: 'Added (Newest)' },
            { id: 'added_asc', label: 'Added (Oldest)' },
            { id: 'written_desc', label: 'Written (Newest)' },
            { id: 'written_asc', label: 'Written (Oldest)' },
        ];

        const DEFAULT_POEM = {
            id: 'desiderata-default',
            title: 'Desiderata',
            author: 'Max Ehrmann',
            publishedDate: '1927',
            content: `Go placidly amid the **noise** and the **haste**, and remember what peace there may be in *silence*. As far as possible, without surrender, be on good terms with all persons.\n\nSpeak your truth quietly and clearly; and listen to others, even to the dull and the ignorant; they too have their story.`,
            tags: ['Inspiration'],
            theme: 'gold',
            type: 'poem',
            performanceLink: '',
            dateAdded: Date.now()
        };

        // --- HELPERS ---
        const formatContent = (text) => {
            if (!text) return null;
            return text.split('\n').map((line, i) => (
                <div key={i} className="min-h-[1em]">
                   {line === '' ? <br/> : parseInline(line)}
                </div>
            ));
        };

        const parseInline = (text) => {
            const parts = text.split(/(\*\*[^*]+\*\*|\*[^*]+\*)/g);
            return parts.map((part, index) => {
                if (part.startsWith('**') && part.endsWith('**')) return <strong key={index}>{part.slice(2, -2)}</strong>;
                if (part.startsWith('*') && part.endsWith('*')) return <em key={index}>{part.slice(1, -1)}</em>;
                return part;
            });
        };

        // --- NEW: CUSTOM AUTOCOMPLETE COMPONENT ---
        const AutocompleteInput = ({ value, onChange, options, placeholder, className }) => {
            const [showSuggestions, setShowSuggestions] = useState(false);
            const wrapperRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setShowSuggestions(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [wrapperRef]);

            const filtered = value ? options.filter(opt => opt.toLowerCase().includes(value.toLowerCase()) && opt !== value) : options;

            return (
                <div className="relative w-full" ref={wrapperRef}>
                    <input 
                        value={value} 
                        onChange={(e) => { onChange(e.target.value); setShowSuggestions(true); }} 
                        onFocus={() => setShowSuggestions(true)}
                        placeholder={placeholder} 
                        className={className} 
                    />
                    {showSuggestions && filtered.length > 0 && (
                        <div className="absolute top-full left-0 right-0 mt-1 bg-[var(--bg-card)] border border-[var(--border)] rounded-lg shadow-xl max-h-40 overflow-y-auto z-50 fade-in">
                            {filtered.map(opt => (
                                <div 
                                    key={opt} 
                                    onClick={() => { onChange(opt); setShowSuggestions(false); }}
                                    className="px-4 py-2 hover:bg-[var(--bg-button)] cursor-pointer text-sm border-b border-[var(--border)] last:border-0"
                                >
                                    {opt}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- COMPONENTS ---
        const PoemCard = ({ p, onClick, onDelete }) => {
            if (!p) return null; 
            return (
                <div onClick={() => onClick(p)} className={`card-frame p-6 rounded-lg active:scale-95 cursor-pointer t-${p.theme}`}>
                    <div className="flex justify-between items-start mb-2 relative z-10">
                        <h3 className="text-xl font-bold flex items-center gap-2 theme-title">
                            {p.title || 'Untitled'}
                            {p.type === 'song' && <span className="opacity-50 text-sm"><Icon name="Music" size={14} /></span>}
                        </h3>
                        <button onClick={(e) => onDelete(p.id, e)} className="p-2 bg-[var(--bg-card)] rounded-full text-[var(--text-muted)] hover:text-red-400 border border-[var(--border)] shadow-sm z-50 pointer-events-auto">
                            <Icon name="Trash" size={16} />
                        </button>
                    </div>
                    <div className="text-sm text-[var(--text-muted)] mb-4 flex justify-between relative z-10">
                        <span>{p.author || 'Unknown'}</span>
                        {p.publishedDate && <span className="opacity-50 text-xs">{p.publishedDate}</span>}
                    </div>
                    {(p.tags || []).length > 0 && (
                        <div className="flex gap-2 relative z-10">
                            {(p.tags || []).map(t => <span key={t} className="text-[10px] uppercase tracking-wider px-2 py-1 rounded bg-[var(--bg-input)] text-[var(--text-muted)] opacity-80">{t}</span>)}
                        </div>
                    )}
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = useState('library'); 
            const [isLoaded, setIsLoaded] = useState(false);
            const [poems, setPoems] = useState([]);
            const [activePoem, setActivePoem] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [activeTag, setActiveTag] = useState('All');
            const [activeType, setActiveType] = useState('All'); 
            const [sortBy, setSortBy] = useState('added_desc');
            const [libraryMode, setLibraryMode] = useState('list'); 
            const [appTheme, setAppTheme] = useState('dusk'); 
            const [activeFont, setActiveFont] = useState('cormorant');
            
            const [editingId, setEditingId] = useState(null);
            const [newTitle, setNewTitle] = useState('');
            const [newAuthor, setNewAuthor] = useState('');
            const [newDate, setNewDate] = useState('');
            const [newContent, setNewContent] = useState('');
            const [newTags, setNewTags] = useState('');
            const [newColor, setNewColor] = useState('gold');
            const [newType, setNewType] = useState('poem');
            const [newYoutube, setNewYoutube] = useState('');
            const [newSpotify, setNewSpotify] = useState('');
            
            // --- NEW: AURA CALCULATION ---
            const auraStats = useMemo(() => {
                if (!poems.length) return [];
                
                // 1. Count usage
                const counts = {};
                poems.forEach(p => {
                    counts[p.theme] = (counts[p.theme] || 0) + 1;
                });
                
                // 2. Map to theme objects and calculate %
                const stats = THEMES.map(t => {
                    const count = counts[t.id] || 0;
                    const percent = Math.round((count / poems.length) * 100);
                    return { ...t, count, percent };
                });
            
                // 3. Filter out unused themes and sort by most used
                return stats.filter(s => s.count > 0).sort((a, b) => b.count - a.count);
            }, [poems]);
            
            const dominantAura = auraStats.length > 0 ? auraStats[0] : null;

            // Autocomplete Data
            const uniqueAuthors = useMemo(() => [...new Set(poems.map(p => p.author).filter(Boolean))].sort(), [poems]);
            const uniqueTags = useMemo(() => [...new Set(poems.flatMap(p => p.tags || []))].sort(), [poems]);

            useEffect(() => {
                try {
                    const savedPoems = JSON.parse(localStorage.getItem('pp_poems_v14'));
                    const savedConfig = JSON.parse(localStorage.getItem('pp_config_v14'));
                    if (savedPoems && Array.isArray(savedPoems)) setPoems(savedPoems);
                    else setPoems([DEFAULT_POEM]);
                    if (savedConfig) {
                        setAppTheme(savedConfig.theme || 'dusk');
                        setActiveFont(savedConfig.font || 'cormorant');
                    }
                } catch (e) {
                    setPoems([DEFAULT_POEM]);
                }
                setIsLoaded(true);
            }, []);

            useEffect(() => {
                if (!isLoaded) return;
                localStorage.setItem('pp_poems_v14', JSON.stringify(poems));
                localStorage.setItem('pp_config_v14', JSON.stringify({ theme: appTheme, font: activeFont }));
                document.body.className = `theme-${appTheme}`;
                const fontCSS = FONTS.find(f => f.id === activeFont)?.css || FONTS[0].css;
                document.documentElement.style.setProperty('--current-font', fontCSS);
            }, [poems, appTheme, activeFont, isLoaded]);

            const toggleAppTheme = () => setAppTheme(prev => prev === 'dusk' ? 'dawn' : 'dusk');

            const startEditing = () => {
                if (!activePoem) return;
                setEditingId(activePoem.id);
                setNewTitle(activePoem.title);
                setNewAuthor(activePoem.author || '');
                setNewDate(activePoem.publishedDate || '');
                setNewContent(activePoem.content);
                setNewTags((activePoem.tags || []).join(' '));
                setNewColor(activePoem.theme);
                setNewType(activePoem.type || 'poem');
                // NEW: Load separate links (with fallback for old data)
                setNewYoutube(activePoem.youtubeLink || activePoem.performanceLink || '');
                setNewSpotify(activePoem.spotifyLink || '');                
                setView('add');
            };

            const handleSave = () => {
                if (!newContent) return;
                const tagsArray = newTags.split(/[, ]+/).filter(Boolean);
                const id = editingId || Date.now().toString();
                const poem = {
                    id: id, title: newTitle || 'Untitled', author: newAuthor, publishedDate: newDate,
                    content: newContent, tags: tagsArray.length ? tagsArray : [], theme: newColor,
                    type: newType, 
                    // NEW: Save separate links
                    youtubeLink: newYoutube,
                    spotifyLink: newSpotify,
                    // remove performanceLink completely to clean up future data
                    dateAdded: editingId ? activePoem.dateAdded : Date.now()
                };
                if (editingId) {
                    setPoems(prev => prev.map(p => p.id === id ? poem : p));
                    setActivePoem(poem);
                } else {
                    setPoems([poem, ...poems]);
                }
                setNewTitle(''); setNewAuthor(''); setNewDate(''); setNewContent(''); setNewTags(''); 
                setNewColor('gold'); setEditingId(null); setNewType('poem'); setNewLink('');
                setView(editingId ? 'read' : 'library');
                setNewYoutube(''); setNewSpotify(''); // Clear inputs
            };

            const handleDelete = (id, e) => {
                if (e) e.stopPropagation();
                if (confirm("Permanently delete this entry?")) {
                    setPoems(prev => prev.filter(p => p.id !== id));
                    if (activePoem?.id === id) {
                        setActivePoem(null);
                        setView('library');
                    }
                }
            };

            const handleTagClick = (tag) => {
                setActiveTag(tag);
                setView('library');
            };

            const exportJSON = () => {
                const data = JSON.stringify(poems);
                navigator.clipboard.writeText(data).then(() => alert("Copied Backup Data."));
            };

            const importJSON = () => {
                const data = prompt("Paste your Backup Data string here:");
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        if (Array.isArray(parsed)) {
                            const cleaned = parsed.map(p => ({
                                ...p, tags: p.tags || [], type: p.type || 'poem',
                                performanceLink: p.performanceLink || '', dateAdded: p.dateAdded || Date.now()
                            }));
                            setPoems(cleaned);
                            alert("Library restored successfully!");
                        }
                    } catch (e) {
                        alert("Invalid data.");
                    }
                }
            };

            const formatDate = (timestamp) => {
                if (!timestamp) return '';
                return new Date(timestamp).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            };

            const allTags = ['All', ...uniqueTags];

            const getProcessedPoems = () => {
                let filtered = poems.filter(p => {
                    if (activeType === 'Poems' && p.type === 'song') return false;
                    if (activeType === 'Songs' && p.type !== 'song') return false;
                    const searchLower = searchQuery.toLowerCase();
                    const matchesSearch = (p.title || '').toLowerCase().includes(searchLower) || (p.author || '').toLowerCase().includes(searchLower) || (p.content || '').toLowerCase().includes(searchLower);
                    const matchesTag = activeTag === 'All' ? true : (p.tags || []).includes(activeTag);
                    return matchesSearch && matchesTag;
                });
                return filtered.sort((a, b) => {
                    if (sortBy === 'added_desc') return parseInt(b.dateAdded || b.id) - parseInt(a.dateAdded || a.id);
                    if (sortBy === 'added_asc') return parseInt(a.dateAdded || a.id) - parseInt(b.dateAdded || b.id);
                    if (sortBy === 'written_desc') return (b.publishedDate || '').localeCompare(a.publishedDate || '');
                    if (sortBy === 'written_asc') return (a.publishedDate || '').localeCompare(b.publishedDate || '');
                    return 0;
                });
            };

            const displayedPoems = getProcessedPoems();

            const renderLibraryContent = () => {
                if (libraryMode === 'author') {
                    const grouped = displayedPoems.reduce((acc, poem) => {
                        const auth = poem.author || 'Unknown';
                        if (!acc[auth]) acc[auth] = [];
                        acc[auth].push(poem);
                        return acc;
                    }, {});
                    const authors = Object.keys(grouped).sort();
                    if (authors.length === 0) return <div className="text-center py-20 text-[var(--text-muted)] opacity-50 italic">No entries found.</div>;
                    return (
                        <div className="space-y-8">
                            {authors.map(auth => (
                                <div key={auth}>
                                    <h3 className="text-[var(--text-muted)] text-xs uppercase tracking-widest border-b border-[var(--border)] pb-2 mb-4 sticky top-[130px] bg-[var(--bg-main)] z-30">{auth}</h3>
                                    <div className="space-y-4">{grouped[auth].map(p => (
                                        <PoemCard key={p.id} p={p} onClick={() => { setActivePoem(p); setView('read'); }} onDelete={handleDelete} />
                                    ))}</div>
                                </div>
                            ))}
                        </div>
                    );
                } else {
                    if (displayedPoems.length === 0) return <div className="text-center py-20 text-[var(--text-muted)] opacity-50 italic">No entries found.</div>;
                    return <div className="space-y-4">{displayedPoems.map(p => (
                        <PoemCard key={p.id} p={p} onClick={() => { setActivePoem(p); setView('read'); }} onDelete={handleDelete} />
                    ))}</div>;
                }
            };

            if (view === 'read' && activePoem) {
                return (
                    <div className={`min-h-screen bg-[var(--bg-main)]`}>
                        <div className="sticky-header flex justify-between items-center px-4">
                            <button onClick={() => setView('library')} className="text-[var(--text-muted)] flex items-center gap-2"><Icon name="ArrowLeft" /> Library</button>
                            <div className="flex gap-2">
                                <button onClick={startEditing} className="text-[var(--text-muted)] p-2 bg-[var(--bg-button)] rounded-full"><Icon name="Edit" /></button>
                                <button onClick={(e) => handleDelete(activePoem.id, e)} className="text-red-400 opacity-80 p-2 bg-[var(--bg-button)] rounded-full"><Icon name="Trash" /></button>
                            </div>
                        </div>
                        <div className="p-6 pb-20 flex justify-center min-h-screen">
                            <div className={`w-full max-w-lg card-frame p-8 md:p-12 rounded-lg relative t-${activePoem.theme}`} >
                                {activePoem.type === 'song' && <div className="absolute top-4 right-4 text-[var(--text-muted)] opacity-20"><Icon name="Music" size={24} /></div>}
                                
                                <h1 className="text-3xl md:text-4xl text-center font-bold mb-2 uppercase tracking-wide theme-title">{activePoem.title}</h1>
                                <div className="text-center italic opacity-70 mb-8 pb-4 border-b border-[var(--border)] mx-10">{activePoem.author} {activePoem.publishedDate && <span className="text-xs ml-1 opacity-60">({activePoem.publishedDate})</span>}</div>
                                
                                <div className="text-lg md:text-xl leading-relaxed whitespace-pre-wrap text-justify pb-8 poem-content">
                                    {formatContent(activePoem.content)}
                                </div>
                                
                                <div className="mt-8 pt-6 border-t border-[var(--border)] flex flex-col items-center gap-6">
                                    <div className="opacity-40 text-xl theme-title">✦ ✦ ✦</div>
                                    
                                    {/* CLICKABLE TAGS */}
                                    {activePoem.tags && activePoem.tags.length > 0 && (
                                        <div className="flex flex-wrap justify-center gap-2">
                                            {activePoem.tags.map(tag => (
                                                <button 
                                                    key={tag} 
                                                    onClick={() => handleTagClick(tag)}
                                                    className="px-4 py-1.5 border border-[var(--border)] rounded text-xs uppercase tracking-widest hover:bg-[var(--bg-button)] transition-colors theme-title opacity-80"
                                                >
                                                    {tag}
                                                </button>
                                            ))}
                                        </div>
                                    )}

                                    <div className="flex flex-col items-center gap-2 w-full">
                                        <div className="flex flex-wrap justify-center gap-3 w-full">
                                    {activePoem.youtubeLink && (
                                        <a href={activePoem.youtubeLink} target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 text-xs uppercase tracking-widest px-4 py-2 rounded-full border border-[var(--border)] hover:bg-[var(--bg-button)] transition-colors theme-title">
                                            <Icon name="YouTube" size={14} /> Watch
                                        </a>
                                    )}
                                    {activePoem.spotifyLink && (
                                        <a href={activePoem.spotifyLink} target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 text-xs uppercase tracking-widest px-4 py-2 rounded-full border border-[var(--border)] hover:bg-[var(--bg-button)] transition-colors theme-title">
                                            <Icon name="Spotify" size={14} /> Listen
                                        </a>
                                    )}
                                </div>
                                        {activePoem.dateAdded && <div className="text-[10px] uppercase tracking-widest text-[var(--text-muted)] opacity-40 mt-2">Added {formatDate(activePoem.dateAdded)}</div>}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'add') {
                return (
                    <div className="min-h-screen bg-[var(--bg-main)]">
                         <div className="sticky-header flex justify-between items-center px-4">
                            <button onClick={() => setView(editingId ? 'read' : 'library')}><Icon name="ArrowLeft" /></button>
                            <h2 className="text-lg font-bold uppercase tracking-widest">{editingId ? 'Edit Entry' : 'New Entry'}</h2>
                            <div className="w-5"></div>
                        </div>
                        <div className="p-6 pb-20 space-y-6 max-w-lg mx-auto">
                            <div className="flex bg-[var(--bg-button)] p-1 rounded-lg">
                                <button onClick={() => setNewType('poem')} className={`flex-1 py-2 text-xs uppercase tracking-wider rounded transition-all ${newType === 'poem' ? 'bg-[var(--bg-card)] shadow-sm text-[var(--text-main)]' : 'text-[var(--text-muted)] opacity-60'}`}>Poem</button>
                                <button onClick={() => setNewType('song')} className={`flex-1 py-2 text-xs uppercase tracking-wider rounded transition-all ${newType === 'song' ? 'bg-[var(--bg-card)] shadow-sm text-[var(--text-main)]' : 'text-[var(--text-muted)] opacity-60'}`}>Song</button>
                            </div>
                            <input placeholder="Title" value={newTitle} onChange={e => setNewTitle(e.target.value)} className="w-full bg-transparent border-b border-[var(--border)] py-3 text-2xl font-bold placeholder-opacity-30 placeholder-[var(--text-muted)] outline-none" />
                            
                            <textarea placeholder={newType === 'song' ? "Lyrics... (Use **bold** and *italics*)" : "Poem... (Use **bold** and *italics*)"} value={newContent} onChange={e => setNewContent(e.target.value)} className="w-full h-64 bg-[var(--bg-input)] rounded p-4 text-lg leading-relaxed outline-none resize-none" />
                            
                            <div className="grid grid-cols-2 gap-4">
                                {/* CUSTOM AUTOCOMPLETE FOR AUTHOR */}
                                <AutocompleteInput 
                                    value={newAuthor} 
                                    onChange={setNewAuthor} 
                                    options={uniqueAuthors} 
                                    placeholder="Author/Artist"
                                    className="w-full bg-transparent border-b border-[var(--border)] py-2 text-[var(--text-muted)] outline-none"
                                />
                                <input placeholder="Year/Date" value={newDate} onChange={e => setNewDate(e.target.value)} className="w-full bg-transparent border-b border-[var(--border)] py-2 text-[var(--text-muted)] outline-none text-right" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div className="relative">
                                    <span className="absolute left-0 top-2 text-[var(--text-muted)] opacity-50"><Icon name="YouTube" size={16}/></span>
                                    <input placeholder="YouTube Link" value={newYoutube} onChange={e => setNewYoutube(e.target.value)} className="w-full bg-transparent border-b border-[var(--border)] py-2 pl-6 text-[var(--text-muted)] outline-none text-sm" />
                                </div>
                                <div className="relative">
                                    <span className="absolute left-0 top-2 text-[var(--text-muted)] opacity-50"><Icon name="Spotify" size={16}/></span>
                                    <input placeholder="Spotify Link" value={newSpotify} onChange={e => setNewSpotify(e.target.value)} className="w-full bg-transparent border-b border-[var(--border)] py-2 pl-6 text-[var(--text-muted)] outline-none text-sm" />
                                </div>
                            </div>                            
                            <div className="bg-[var(--bg-card)] p-4 rounded-lg border border-[var(--border)] space-y-4">
                                {/* CUSTOM AUTOCOMPLETE FOR TAGS */}
                                <AutocompleteInput 
                                    value={newTags} 
                                    onChange={setNewTags} 
                                    options={uniqueTags} 
                                    placeholder="Tags (e.g. Sleep, Nature)"
                                    className="w-full bg-transparent text-sm outline-none"
                                />
                                <div className="text-xs text-[var(--text-muted)] uppercase tracking-wider mb-2">Theme: {THEMES.find(t => t.id === newColor)?.name}</div>
                                <div className="flex flex-wrap gap-3">
                                    {THEMES.map(t => (
                                        <button key={t.id} onClick={() => setNewColor(t.id)} className={`w-6 h-6 rounded-full transition-transform ${newColor === t.id ? 'scale-125 ring-2 ring-[var(--text-main)]' : 'opacity-60'}`} style={{ backgroundColor: t.color }} title={t.name} />
                                    ))}
                                </div>
                            </div>
                            <button onClick={handleSave} className="w-full bg-[var(--text-main)] text-[var(--bg-main)] py-4 font-bold uppercase tracking-widest rounded shadow-lg hover:opacity-90">{editingId ? 'Update' : 'Save'}</button>
                        </div>
                    </div>
                );
            }

            if (view === 'settings') {
                return (
                    <div className="min-h-screen bg-[var(--bg-main)]">
                        <div className="sticky-header flex justify-between items-center px-4">
                            <button onClick={() => setView('library')}><Icon name="ArrowLeft" /></button>
                            <h2 className="text-lg font-bold uppercase tracking-widest">Config</h2>
                            <div className="w-5"></div>
                        </div>
                        <div className="p-6 pb-20 space-y-8 max-w-lg mx-auto">
                            
                            {/* --- NEW: AURA STATS SECTION --- */}
                            <div>
                                <h3 className="text-xs uppercase tracking-widest text-[var(--text-muted)] mb-3">Your Aura</h3>
                                <div className="bg-[var(--bg-card)] border border-[var(--border)] rounded-lg p-6">
                                    {dominantAura ? (
                                        <>
                                            <div className="text-center mb-6">
                                                <div className="text-[10px] text-[var(--text-muted)] uppercase tracking-widest mb-1 opacity-60">Dominant Energy</div>
                                                <div className="text-3xl font-serif font-bold tracking-wide" style={{ color: dominantAura.color }}>
                                                    {dominantAura.name}
                                                </div>
                                                <div className="text-xs opacity-40 mt-1 italic">
                                                    {dominantAura.percent}% of your library
                                                </div>
                                            </div>
                                            <div className="space-y-3">
                                                {auraStats.map(s => (
                                                    <div key={s.id} className="flex items-center gap-3 text-xs">
                                                        <div className="w-16 text-right opacity-60 font-serif">{s.name}</div>
                                                        <div className="flex-1 h-1.5 bg-[var(--bg-button)] rounded-full overflow-hidden">
                                                            <div 
                                                                className="h-full rounded-full transition-all duration-1000 ease-out" 
                                                                style={{ width: `${s.percent}%`, backgroundColor: s.color }}
                                                            ></div>
                                                        </div>
                                                        <div className="w-8 text-right font-mono opacity-40">{s.count}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        </>
                                    ) : (
                                        <div className="text-center opacity-40 italic text-sm">Add some poems to reveal your aura.</div>
                                    )}
                                </div>
                            </div>
            
                            {/* Typography Section */}
                            <div>
                                <h3 className="text-xs uppercase tracking-widest text-[var(--text-muted)] mb-3">Typography</h3>
                                <div className="bg-[var(--bg-card)] border border-[var(--border)] rounded-lg overflow-hidden">
                                    {FONTS.map(f => (
                                        <button key={f.id} onClick={() => setActiveFont(f.id)} className={`w-full text-left p-4 flex justify-between items-center border-b border-[var(--border)] last:border-0 ${activeFont === f.id ? 'bg-[var(--bg-input)]' : ''}`} style={{ fontFamily: f.css }}>
                                            <span className="text-lg">{f.name}</span>
                                            {activeFont === f.id && <span className="text-xs">ACTIVE</span>}
                                        </button>
                                    ))}
                                </div>
                            </div>
            
                            {/* Backup Section */}
                            <div>
                                <h3 className="text-xs uppercase tracking-widest text-[var(--text-muted)] mb-3">Backup</h3>
                                <div className="space-y-3">
                                    <button onClick={exportJSON} className="w-full bg-[var(--bg-card)] border border-[var(--border)] p-4 rounded-lg flex items-center gap-3"><Icon name="Copy" /><div className="text-left"><div className="font-bold">Export Data (JSON)</div><div className="text-xs text-[var(--text-muted)]">Safety backup</div></div></button>
                                    <button onClick={importJSON} className="w-full bg-[var(--bg-card)] border border-[var(--border)] p-4 rounded-lg flex items-center gap-3"><Icon name="Upload" /><div className="text-left"><div className="font-bold">Import Data</div><div className="text-xs text-[var(--text-muted)]">Restore library</div></div></button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-[var(--bg-main)] relative pb-24">
                    <div className="sticky-header flex justify-between items-center px-6">
                        <h1 className="text-xl font-bold tracking-tight">Library</h1>
                        <div className="flex gap-2">
                            <button onClick={() => setView('settings')} className="p-2 bg-[var(--bg-button)] rounded-full text-[var(--text-muted)]"><Icon name="Settings" /></button>
                            <button onClick={toggleAppTheme} className="p-2 bg-[var(--bg-button)] rounded-full text-[var(--text-muted)]"><Icon name={appTheme === 'dusk' ? 'Moon' : 'Sun'} /></button>
                        </div>
                    </div>

                    <div className="px-6 mb-4 max-w-lg mx-auto w-full space-y-4 pt-4">
                        <div className="relative mt-2">
                            <span className="absolute left-3 top-2.5 text-[var(--text-muted)] opacity-50"><Icon name="Search" size={18}/></span>
                            <input placeholder="Search..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="w-full bg-[var(--bg-input)] pl-10 pr-4 py-2 rounded-lg text-sm outline-none focus:ring-1 ring-[var(--text-muted)] transition-all" />
                        </div>
                        <div className="flex bg-[var(--bg-button)] p-1 rounded-lg">
                            {['All', 'Poems', 'Songs'].map(type => (
                                <button key={type} onClick={() => setActiveType(type)} className={`flex-1 py-1.5 text-xs uppercase tracking-wider rounded transition-all ${activeType === type ? 'bg-[var(--bg-card)] shadow-sm text-[var(--text-main)]' : 'text-[var(--text-muted)] opacity-60'}`}>{type}</button>
                            ))}
                        </div>
                        <div className="flex justify-between items-center gap-2 overflow-x-auto no-scrollbar pb-1">
                            <div className="relative shrink-0 flex gap-2">
                                <select value={sortBy} onChange={(e) => setSortBy(e.target.value)} className="appearance-none bg-[var(--bg-button)] border border-[var(--border)] text-[var(--text-muted)] text-xs uppercase tracking-wide px-3 py-1.5 rounded-full outline-none pr-8">
                                    {SORT_OPTIONS.map(opt => <option key={opt.id} value={opt.id}>{opt.label}</option>)}
                                </select>
                                <button onClick={() => setLibraryMode(prev => prev === 'list' ? 'author' : 'list')} className={`bg-[var(--bg-button)] border border-[var(--border)] text-[var(--text-muted)] px-3 py-1.5 rounded-full ${libraryMode === 'author' ? 'bg-[var(--accent)] text-[var(--bg-main)] border-transparent' : ''}`} title="Group by Author">
                                    <Icon name={libraryMode === 'author' ? 'User' : 'List'} size={14} />
                                </button>
                            </div>
                            <div className="flex gap-2">
                                {allTags.map(tag => (
                                    <button key={tag} onClick={() => setActiveTag(tag)} className={`tag-pill ${activeTag === tag ? 'active' : ''}`}>{tag}</button>
                                ))}
                            </div>
                        </div>
                        {renderLibraryContent()}
                    </div>

                    <div className="fixed bottom-8 right-6 z-40">
                        <button onClick={() => { setEditingId(null); setView('add'); }} className="w-16 h-16 bg-[var(--text-main)] text-[var(--bg-main)] rounded-full shadow-xl flex items-center justify-center hover:scale-105 active:scale-90 transition-transform"><Icon name="Plus" size={32} /></button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
